# Local testing setup for gameTaskEmulator
#
# Starts a Google Cloud Tasks emulator so you can test the full flow locally:
#   Real NHL API -> Local task queue -> Discord notification
#
# Tasks will be created in the local emulator and dispatch will fail
# (no backend running at the target URL), which is expected behavior
# for testing without affecting any production queues.
#
# Usage:
#
#   1. Copy .env.example to .env and set your Discord webhook URL:
#        cp .env.example .env
#
#   2. Start the Cloud Tasks emulator:
#        docker compose up
#
#   3. In another terminal, build and run the app:
#        go run build.go -target gameTaskEmulator
#        ./bin/gameTaskEmulator -local -today -discord-webhook "$DISCORD_WEBHOOK_URL"
#
#   Or run the app via compose (builds from Dockerfile):
#        docker compose --profile app run --rm app -local -today
#
#   Customize team/date:
#        ./bin/gameTaskEmulator -local -today -teams CHI -discord-webhook "$DISCORD_WEBHOOK_URL"
#        ./bin/gameTaskEmulator -local -date 2025-03-15 -all -discord-webhook "$DISCORD_WEBHOOK_URL"

services:
  cloud-tasks-emulator:
    image: ghcr.io/aertje/cloud-tasks-emulator:latest
    ports:
      - "8123:8123"
    command:
      - "-queue"
      - "projects/localproject/locations/us-south1/queues/gameschedule"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  app:
    profiles: ["app"]
    build:
      context: .
      dockerfile: Dockerfile
    network_mode: host
    environment:
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
    depends_on:
      - cloud-tasks-emulator
