# Local testing setup for gameTaskEmulator
#
# Starts a Google Cloud Tasks emulator so you can test the full flow locally:
#   Real NHL API -> Local task queue -> Discord notification
#
# Tasks will be created in the local emulator and dispatch will fail
# (no backend running at the target URL), which is expected behavior
# for testing without affecting any production queues.
#
# Usage:
#
#   1. Copy .env.example to .env and set your Discord webhook URL:
#        cp .env.example .env
#
#   2. Start the Cloud Tasks emulator:
#        docker compose up
#
#   3. In another terminal, build and run the app:
#        go run build.go -target gameTaskEmulator
#        ./bin/gameTaskEmulator -local -today -discord-webhook "$DISCORD_WEBHOOK_URL"
#
#   Or run the app via compose (builds from Dockerfile):
#        docker compose --profile app run --rm app -local -today
#
#   Customize team/date:
#        ./bin/gameTaskEmulator -local -today -teams CHI -discord-webhook "$DISCORD_WEBHOOK_URL"
#        ./bin/gameTaskEmulator -local -date 2025-03-15 -all -discord-webhook "$DISCORD_WEBHOOK_URL"

services:
  cloud-tasks-emulator:
    image: ghcr.io/aertje/cloud-tasks-emulator:latest
    ports:
      - "8123:8123"
    command:
      - "-host"
      - "0.0.0.0"
      - "-queue"
      - "projects/localproject/locations/us-south1/queues/gameschedule"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  app:
    profiles: ["app"]
    build:
      context: .
      dockerfile: Dockerfile
    network_mode: host
    environment:
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
    depends_on:
      - cloud-tasks-emulator

  gametask-emulator-scheduled:
    profiles: ["scheduled"]
    build:
      context: .
      dockerfile: Dockerfile.scheduled
    container_name: gametask-emulator-scheduled
    restart: unless-stopped

    # Environment variables for configuration
    environment:
      # Timezone - set this to your local timezone
      - TZ=America/Chicago

      # Team code(s) - comma-separated list (e.g., CHI,DAL,BOS)
      # Leave empty or comment out to use default team
      - TEAM_CODE=${TEAM_CODE:-}

      # Additional flags to pass to gameTaskEmulator
      # Common flags: -local, -today, -prod, -all, -test
      # Default sends to local task queue at http://host.docker.internal:8080
      - ADDITIONAL_FLAGS=${ADDITIONAL_FLAGS:--local -today}

      # Google Cloud credentials (if using production mode)
      # - GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-key.json

    # Mount Google Cloud credentials if needed
    # Uncomment the volumes section below if you're using -prod flag
    # volumes:
    #   - ${GOOGLE_APPLICATION_CREDENTIALS}:/secrets/gcp-key.json:ro

    # Add host.docker.internal for local development (allows -local flag to work)
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check (optional - checks if cron is running)
    healthcheck:
      test: ["CMD", "pgrep", "crond"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 10s

# Example configurations:
#
# Default configuration (local task queue):
#   environment:
#     - TZ=America/Chicago
#     - TEAM_CODE=CHI
#     - ADDITIONAL_FLAGS=-local -today
#
# For multiple teams with local task queue:
#   environment:
#     - TEAM_CODE=CHI,DAL,BOS
#     - ADDITIONAL_FLAGS=-local -today
#
# For all teams with local task queue:
#   environment:
#     - ADDITIONAL_FLAGS=-local -today -all
#
# For production mode with GCP credentials:
#   environment:
#     - TEAM_CODE=CHI
#     - ADDITIONAL_FLAGS=-today -prod
#     - GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-key.json
#   volumes:
#     - ./path/to/your/gcp-key.json:/secrets/gcp-key.json:ro
